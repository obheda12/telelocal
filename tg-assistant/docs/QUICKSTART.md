# Deployment Quick Reference

For the full security analysis and architecture documentation, see the [main README](../../README.md).

This document is a condensed deployment checklist for the Telegram Personal Assistant.

---

## Pre-Flight Checklist

### Hardware and OS

- [ ] Raspberry Pi 4 (4GB+) or Pi 5
- [ ] Raspberry Pi OS 64-bit or Ubuntu 22.04+ ARM64
- [ ] 32GB+ SD card or USB SSD (SSD recommended for database performance)
- [ ] Adequate cooling (heatsink + fan recommended -- PostgreSQL and sync both generate sustained load)
- [ ] Stable internet connection (Ethernet preferred)
- [ ] SSH access configured

### Accounts and Credentials

- [ ] **Telegram account** -- the account whose messages will be synced (requires phone number + 2FA)
- [ ] **Telegram bot** -- created via [@BotFather](https://t.me/BotFather) (this is your query interface)
- [ ] **Anthropic API key** -- from [console.anthropic.com](https://console.anthropic.com/)

---

## Deployment Steps

### 1. System Preparation

```bash
sudo apt update && sudo apt upgrade -y
```

### 2. Run Setup Script

```bash
./scripts/setup-raspberry-pi.sh
```

This installs and configures:
- Python 3.11+ with virtual environment
- PostgreSQL 15/16 with pgvector extension
- nftables firewall rules (per-process network restrictions)
- Dedicated system users (`tg-syncer`, `tg-querybot`)
- systemd service files with hardening profiles
- Configuration files in `/etc/tg-assistant/`

### 3. Create Telethon Session

```bash
./scripts/setup-telethon-session.sh
```

This is interactive. You will be prompted for:
1. Your phone number (the Telegram account to sync)
2. The verification code sent to your Telegram
3. Your 2FA password (if enabled)

The session file is stored encrypted in `/home/tg-syncer/.telethon/`.

**Important**: This session grants full account access. Treat it like a password.

### 4. Create Telegram Bot

1. Open Telegram, message [@BotFather](https://t.me/BotFather)
2. Send `/newbot`
3. Choose a name and username
4. Save the bot token

### 5. Configure Credentials

Store all credentials in the system keychain (never in config files or environment variables directly):

```bash
# Bot token from step 4
secret-tool store --label="tg-querybot-token" service tg-assistant key bot_token

# Anthropic API key
secret-tool store --label="tg-claude-key" service tg-assistant key anthropic_api_key

# Database passwords (generated by setup script)
```

Edit `/etc/tg-assistant/settings.toml` to set your `owner_id` (your Telegram user ID) and any other preferences.

### 6. Verify Security

```bash
./tests/security-verification.sh
```

All tests should pass before starting services. This checks:
- File permissions on session and config files
- nftables rules are active
- Database role separation is correct
- systemd hardening directives are applied

### 7. Start Services

```bash
sudo systemctl enable tg-syncer tg-querybot
sudo systemctl start tg-syncer tg-querybot
```

---

## File Locations

| Description | Path |
|-------------|------|
| Configuration | `/etc/tg-assistant/settings.toml` |
| System prompt | `/etc/tg-assistant/system_prompt.md` |
| Audit logs | `/var/log/tg-assistant/audit.log` |
| Telethon session | `/home/tg-syncer/.telethon/` (encrypted, `0700`) |
| Syncer service | `/etc/systemd/system/tg-syncer.service` |
| Query bot service | `/etc/systemd/system/tg-querybot.service` |
| Firewall rules | `/etc/nftables.d/tg-assistant-firewall.conf` |

---

## Common Commands

```bash
# Check service status
systemctl status tg-syncer tg-querybot

# View syncer logs (live)
journalctl -u tg-syncer -f

# View query bot logs (live)
journalctl -u tg-querybot -f

# View audit log
tail -f /var/log/tg-assistant/audit.log

# Restart after config change
sudo systemctl restart tg-syncer tg-querybot

# Monitor network traffic (30-second capture)
sudo ./scripts/monitor-network.sh 30
```

---

## Troubleshooting

### Service won't start

```bash
# Check logs for the failing service
journalctl -u tg-syncer -n 100 --no-pager
journalctl -u tg-querybot -n 100 --no-pager

# Common causes: missing credentials, bad permissions, Python import errors
```

### Database connection failed

```bash
# Check PostgreSQL is running
systemctl status postgresql

# Test connection
sudo -u postgres psql -c "SELECT 1;"

# Check role exists
sudo -u postgres psql -c "\du" | grep -E "syncer|querybot"
```

### Bot not responding

```bash
# Verify the bot token is valid
curl -s "https://api.telegram.org/bot<YOUR_TOKEN>/getMe" | python3 -m json.tool

# Check that owner_id in settings.toml matches your Telegram user ID
# The bot silently ignores messages from non-owner accounts
```

### Telethon session errors

```bash
# Check session file exists and has correct permissions
ls -la /home/tg-syncer/.telethon/

# Session expired or invalidated -- recreate it
sudo systemctl stop tg-syncer
./scripts/setup-telethon-session.sh
sudo systemctl start tg-syncer
```

### Rate limiting

```bash
# Check for FloodWaitError in syncer logs
journalctl -u tg-syncer --since "1 hour ago" | grep -i flood

# Telegram enforces strict rate limits on the User API (MTProto).
# The syncer has built-in backoff. If rate-limited, it will retry automatically.
# Do NOT decrease the sync interval below the configured default.
```

---

## Security Verification Commands

```bash
# Verify only expected network traffic (should see only Telegram + Anthropic endpoints)
sudo tcpdump -i any -n 'not host api.telegram.org and not host api.anthropic.com and not localhost' -c 10

# Check for injection attempts in audit log
grep -i "injection\|blocked\|denied" /var/log/tg-assistant/audit.log

# Verify config file permissions (should be 600 or 640)
stat -c '%a %U:%G %n' /etc/tg-assistant/settings.toml

# Verify session file permissions (should be 0700 directory, 0600 files)
sudo ls -la /home/tg-syncer/.telethon/

# Check active Telethon sessions on your account
# Open Telegram > Settings > Devices -- verify only expected sessions exist
```

---

## Updating

```bash
cd ~/tg-assistant
git pull

# Update Python dependencies
source venv/bin/activate
pip install -r requirements.txt

# Restart services
sudo systemctl restart tg-syncer tg-querybot

# Always re-verify security after updates
./tests/security-verification.sh
```
